<div id=main>
	<canvas id="board" width="1500px", height="800px"></canvas>
</div>

<script type="text/javascript">

var colors = {
	FIREBAR:["#00FF00","#6EFF00","#FFFF00","#FFAC00","#FF0000"],
	PLAYERA:"#F93672",
	PLAYERB:"#66D9EF",
	GOODEFFECTSBAR:"#66D9EF55",
	BADEFFECTSBAR:"#F9367255",
	GOODEFFECTS:"#66D9EF",
	BADEFFECTS:"#F93672",
	NORMALBULLET:"#E6DB74",
	LOCKDOWN:"#AE81FF",
	SUPPRESSION:"#FF0000",
	ACID:"#A6E22E",
	HEAL:"#00FF00",
	BACKGROUND:"#272822",
	LAND:"#F8F8F2",
	HPBAR:"#52C41A",
	HPBAR_RB:"#72E43A",
	HPBAR_LIMIT:"#666761",
	BARBACKGROUND:"#464741"
};

var effects = {
	colors:["#FFFFFF",colors.LOCKDOWN,colors.SUPPRESSION,colors.ACID,colors.HEAL,"#FFFFFF","#FFFFFF"],
	names:["None","Lockdown","Suppression","Acid","Heal","Lockdown resistance","Suppression resistance"],
	opposite:[-1,5,6,-1,-1,-1,-1],
	have_times:[0,400,600,300,251,400,700],
	been_times:[0,200,400,100,0,0,0],
	NONE:0,
	LOCKDOWN:1,
	SUPPRESSION:2,
	ACID:3,
	HEAL:4,
	LOCKDOWN_RESISTANCE:5,
	SUPPRESSION_RESISTANCE:6
};

var ph = 20, pw = 5;
var kh = 10, kw = 10;
var w = 1500, h = 800;
var common_spd = .4;
var pbw = 100,pbh = 3;
var hpbw = 500 ,hpbh= 20;
max = Math.max;
min = Math.min;

var cvs;
var playerA = new Player();
var playerB = new Player();
var lands = new Array();
var effectpacks= new Array();
var clock = 0;

function dist(ax, ay, bx, by) {
	// let dft = {
	// 	x: 0, y: 0,
	// };
	// complete_with_default(a, dft);
	// complete_with_default(b, dft);
	let xd=ax-bx;
	let yd=ay-by;
	return Math.sqrt(xd*xd+yd*yd);
}

function common_check_crash(a, b) {
	let dft = {
		xl: 0, yl: 0,
		xa: 0, ya: 0,
	};
	complete_with_default(a, dft);
	complete_with_default(b, dft);

	let minAx = min(a.x, a.x + a.xl, a.x + a.xa, a.x + a.xl + a.xa);
	let minBx = min(b.x, b.x + b.xl, b.x + b.xa, b.x + b.xl + b.xa);
	let minAy = min(a.y, a.y + a.yl, a.y + a.ya, a.y + a.yl + a.ya);
	let minBy = min(b.y, b.y + b.yl, b.y + b.ya, b.y + b.yl + b.ya);

	let maxAx = max(a.x, a.x + a.xl, a.x + a.xa, a.x + a.xl + a.xa);
	let maxBx = max(b.x, b.x + b.xl, b.x + b.xa, b.x + b.xl + b.xa);
	let maxAy = max(a.y, a.y + a.yl, a.y + a.ya, a.y + a.yl + a.ya);
	let maxBy = max(b.y, b.y + b.yl, b.y + b.ya, b.y + b.yl + b.ya);

	if (minAx <= maxBx && maxAx >= minBx && minAy <= maxBy && maxAy >= minBy) { return true; }
	return false;
}

function get_random(min, max) {
  min = Math.ceil(min);
  max = Math.floor(max);
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function Effect(type, time){
	this.type=type;
	this.time=time;
	this.atime=time;
	this.dtime = () => {
		// console.log("An effect have time "+this.time);
		if (this.time >= 0) {
			this.time -= 1;
		}
	};
	
}

function Player() {
	this.color="#000000";

	this.in_fire = false;

	this.space_jump = 0;
	this.blood = 100;
	this.real_blood = 100;
	this.blood_limit = 100;
	this.rblood_drop = 0;

	this.bullets = new Array();

	this.have_effects = new Array();
	this.been_effects = new Array();

	this.d = 1;

	this.x = 150;
	this.y = -500;

	this.xa = 0;
	this.ya = 0;

	this.xaa = 0;
	this.yaa = 0.5 * common_spd;

	this.fire_cnt = 0;
	this.fire_time = 0;

	this.jump = () => {
		if(this.count_been_effect(effects.LOCKDOWN)) {
			return;
		}
		if (this.space_jump >= 3) { return; }
		this.ya = -25 * common_spd;
		this.space_jump += 1;
	};

	this.update = () => {
		if (Math.abs(this.xa) < 1e-6) { this.xaa = 0; }
		this.xa += this.xaa;
		this.ya += this.yaa;
		this.ya = min(this.ya, 10);
		this.x += this.xa;
		
		this.real_blood=max(this.blood,this.real_blood-max(0,this.rblood_drop));
		if(this.real_blood!=this.blood)
		{
			this.rblood_drop += 0.02;
		} else {
			this.rblood_drop = -0.5;
		}

		if (this.ya >= 0) {
			for ( let l in lands) {
				if (lands[l].check_crash(this.x, this.y, ph + this.ya)) {
					this.y = lands[l].y - ph;
					this.ya = 0;
					this.space_jump = 0;
					break;
				}
			}
		}
		this.y += this.ya;

		if (this.fire_time > 0) {
			this.fire_time -= 1;
		}
		// console.log(this.fire_time);
		if (this.in_fire && this.fire_time == 0) {
			this.fire();
		} else if(this.fire_time == 0) {
			this.fire_cnt -= 0.35;
			this.fire_cnt = max(this.fire_cnt, 0);
		}

		for ( let i in this.bullets) {
			this.bullets[i].update();
			// alert("Have a bullet");
			if(this.bullets[i].alive()) {
				this.bullets[i].draw();
			}
		}

		if (true) {
			let n = new Array();
			for ( let i in this.bullets) {
				let e = this.bullets[i];
				if (e.alive()) {
					n.push(e);
				}
			}
			this.bullets = n;
		}
		// console.log(this.blood_limit);
		if (this.count_have_effect(effects.HEAL)) {
			this.blood += this.count_have_effect(effects.HEAL)/10.0;
			if(this.blood>=this.blood_limit)this.blood=this.blood_limit;
		}
		if (this.count_been_effect(effects.ACID)) {
			this.been_attacked(this.count_been_effect(effects.ACID)/20.0);
		}

		this.check_hit_pack(this);
		this.update_effects();

		this.draw();
	};

	this.get_firebar_color = () => {
		if (this.fire_cnt!=0) { return colors.FIREBAR[Math.floor((this.fire_cnt-1)/10)]; }
		else { return "#FFFFFF"; }
	}

	this.draw = () => {
		cvs.fillStyle = this.color;
		cvs.fillRect(this.x, this.y, pw, ph);
		cvs.fillRect(this.x + pw * this.d, this.y, 5, 5);
		cvs.font = "10px Consolas";
		cvs.fillText(Math.ceil((this.blood.toFixed(2))), this.x, this.y - 10);
		cvs.fillStyle = colors.BARBACKGROUND + "88";
		cvs.fillRect(this.x - 15,this.y + 25,30,3);
		// console.log(this.get_firebar_color());
		cvs.fillStyle = (this.get_firebar_color()) + "BB";
		cvs.fillRect(this.x-this.fire_cnt/100*60/2,this.y + 25,this.fire_cnt/100*60,3);
	};

	this.left = () => {
		if (!this.count_been_effect(effects.LOCKDOWN)) {
			this.xaa = 0.1;
			this.xa = -5;
		}
		this.d = -1;
	};

	this.right = () => {
		if (!this.count_been_effect(effects.LOCKDOWN)) {
			this.xaa = -.1;
			this.xa = 5;
		}
		this.d = 1;
	};

	this.fire = () => {
		if (this.fire_time != 0) {
			return;
		}
		this.fire_time = Math.round(this.fire_cnt / 10) + 8;
		if (this.fire_cnt < 50) {
			this.fire_cnt += 1;
		}
		let ef = new Array();
		if (this.count_have_effect(effects.LOCKDOWN)){
			ef.push(new Effect(effects.LOCKDOWN,effects.been_times[effects.LOCKDOWN]));
		}
		if (this.count_have_effect(effects.SUPPRESSION)){
			ef.push(new Effect(effects.SUPPRESSION,effects.been_times[effects.SUPPRESSION]));
		}
		if (this.count_have_effect(effects.ACID)){
			ef.push(new Effect(effects.ACID,effects.been_times[effects.ACID]));
		}
		this.bullets.push(new Bullet(this.x, this.y + 2, this.d, this.count_been_effect(effects.SUPPRESSION) ? 5 : 10, ef, this.fire_cnt, 1000));
		this.xaa = this.d * .01;
		this.xa = -this.d * 1;
	};

	this.check_hit = (target) => {
		for ( let i in this.bullets) {
			let e = this.bullets[i];
			if (!e.alive()) { continue; }
			if (e.check_crash(target.x, target.y, pw, ph)) {
				target.been_hit(e);
				e.done = true;
				break;
			}
		}
	}

	this.check_hit_pack = (target) => {
		for ( let i in effectpacks) {
			let e = effectpacks[i];
			// if (!e.alive()) { continue; }
			// alert("Checking packs");
			if (e.check_pack_crash(target.x, target.y, kw, kh)) {
				// alert("Pick a pack");
				effectpacks[i].alive=0;
				target.pick_pack(new Effect(e.effect,e.time));
				break;
			}
		}
	}

	this.pick_pack = (d) => {
		this.have_effects.push(d);
	}

	this.count_been_effect = (d) => {
		let ret = 0;
		for ( let i in this.been_effects) {
			if (this.been_effects[i].type==d) {
				ret += 1;
			}
		}
		return ret;
	}
	this.count_have_effect = (d) => {
		let ret = 0;
		for ( let i in this.have_effects) {
			if (this.have_effects[i].type==d) {
				ret += 1;
			}
		}
		return ret;
	}

	this.find_been_effect = (d) => {
		let ret = new Array();
		for ( let i in this.been_effects) {
			if (this.been_effects[i].type==d) {
				ret.push(this.been_effects[i]);
			}
		}
		return ret;
	}
	this.find_have_effect = (d) => {
		let ret = new Array();
		for ( let i in this.have_effects) {
			if (this.have_effects[i].type==d) {
				ret.push(this.have_effects[i]);
			}
		}
		return ret;
	}

	this.update_effects = () => {
		for ( let i in this.have_effects) {
			this.have_effects[i].dtime();
			let e=this.have_effects[i];
			if (e.time <= 0){
				this.have_effects[i]=this.have_effects[this.have_effects.length-1];
				this.have_effects.pop();
			}
		}
		for ( let i in this.been_effects) {
			this.been_effects[i].dtime();
			let e=this.been_effects[i];
			if (e.time <= 0){
				this.been_effects[i]=this.been_effects[this.been_effects.length-1];
				this.been_effects.pop();
			}
		}
	}

	this.been_hit = (e) => {
		d = -e.d;
		// console.log(e.effects);
		for ( let i in e.effects) {
			if(effects.opposite[e.effects[i].type]!=-1&&this.count_have_effect(effects.opposite[e.effects[i].type])==0) {
				this.been_effects.push(e.effects[i]);
				this.have_effects.push(new Effect(effects.opposite[e.effects[i].type],effects.have_times[effects.opposite[e.effects[i].type]]));
			} else if (effects.opposite[e.effects[i].type] == -1) {
				this.been_effects.push(e.effects[i]);
			}
		}
		if (!this.count_been_effect(effects.LOCKDOWN)){
			this.xaa = d * .1;
			this.xa += -d * 10;
		}
		this.been_attacked(e.damage);
	}

	this.been_attacked = (dmg) => {
		this.blood -= dmg;
		this.blood_limit -= dmg/2;
	}

	this.alive = () => {
		if (this.blood <= 0 || this.y > w + 100) { return false; }
		return true;
	};

	this.down = () => {
		if(this.count_been_effect(effects.LOCKDOWN)) {
			return;
		}
		this.y += ph + 1;
	};

	this.start_fire = () => {
		this.in_fire = true;
	};

	this.stop_fire = () => {
		this.in_fire = false;
	};
}

function Effect_pack(x, y, tp) {
	this.x=x;
	this.y=y;
	this.effect = tp;
	this.time = effects.have_times[tp];
	this.alive = 1;
	this.check_pack_crash = (x, y, xl, yl) => {
		// alert(x+" "+this.x+" "+y+" "+this.y);
		xl=yl=30;
		if (!this.alive){
			return false;
		}
		if ((x - xl <= this.x && x + xl >= this.x) && (y - yl <= this.y && y + yl >= this.y)) {
			return true;
		}
		return false;
	};
	this.draw = () => {
		if(!this.alive){
			return;
		}
		cvs.fillStyle = effects.colors[this.effect];
		cvs.fillRect(x-(kh/2),y-(kw/2),kh,kw);
	};
}

function Land(x, y, l) {
	this.len = l || 150;
	this.x = x || get_random(50,w-this.len-50);
	this.y = y || get_random(100,h);
	//console.log("Land at "+this.x.toString()+" , "+this.y.toString());

	this.check_crash = (x, y, h) => {
		if (x >= this.x && x <= this.x + this.len) {
			if (y <= this.y && y + h >= this.y) {
				return true;
			}
		}
		return false;
	};

	this.draw = () => {
		cvs.fillStyle = colors.LAND;
		cvs.fillRect(this.x, this.y, this.len, 2);
	};
}

function Bullet(x, y, d, dmg, ef, fcnt, maxdis) {
	this.d = d;
	this.done = false;

	this.effects=ef;
	this.damage=dmg;

	this.x = x;
	this.y = y;

	this.sx = x;
	this.sy = y;

	this.maxdis=maxdis;

	this.xa = d * 15;
	this.ya = (Math.round(Math.random()) * 20 * (fcnt/100) - 10 * fcnt / 100) * Math.random() / 4;

	this.xaa = 0;
	this.yaa = 0.004;

	this.update = () => {
		this.x += this.xa;
		this.y += this.ya;
		this.xa += this.xaa;
		this.ya += this.yaa;

		// console.log("A bullet flew " + dist(this.x, this.y, this.sx, this.sy));
		if(dist(this.x, this.y, this.sx, this.sy)>=this.maxdis) {
			// console.log("Done!");
			this.done=1;
		}
	};

	this.count_effect = (d) => {
		for ( let i in this.effects) {
			if (this.effects[i].type==d) {
				return true;
			}
		}
		return false;
	}

	this.draw = () => {
		if (this.effects.length) {
			for ( let i in this.effects) {
				let e=this.effects[i];
				cvs.fillStyle = effects.colors[e.type];
				cvs.fillRect(this.x + 10/this.effects.length*i, this.y, 10/this.effects.length, 3);
			}
		}
		else {
			cvs.fillStyle = colors.NORMALBULLET;
			cvs.fillRect(this.x, this.y, 10, 3);
		}
	};

	this.alive = () => {
		if (this.done || this.x < 0 || this.x > w) { return false; }
		return true;
	};

	this.check_crash = (x, y, xl, yl) => {
		if ((x <= this.x && x + xl + this.d * this.xa >= this.x) && (y <= this.y && y + yl >= this.y)) {
			return true;
		}
		return false;
	};
}

function make_map() {
	for (let i = 0; i < 30; i += 1) { lands.push(new Land()) }
	lands.sort((x, y) => { return y.y - x.y; });
}

function init() {
	cvs = document.getElementById('board').getContext('2d');

	make_map();
	playerA.x = w - 150;

	requestAnimationFrame(update);
}

function draw_background() {
	cvs.fillStyle = colors.BACKGROUND;
	cvs.fillRect(0, 0, w, h);
}

function generatepack() {
	if(Math.random()<=1/200) {
		let posx,posy;
		let e=get_random(0,lands.length-1);
		let ef=get_random(1,4);
		//console.log("generating a new effect pack on land "+e+" with effect "+ef);
		effectpacks.push(new Effect_pack(lands[e].x+get_random(20,lands[e].len-20),lands[e].y-10,ef));
	}
}
function delpacks() {
	for (i in effectpacks) {
		if (!effectpacks[i].alive) {
			effectpacks[i] = effectpacks[effectpacks.length - 1];
			effectpacks.pop();
		}
	}
} 

function draweffects(x,y,p,ty) {
	let vis=new Array();
	vis.push(0,0,0,0,0);
	cvs.font="20px Consolas";
	for (i in p.have_effects) {
		let e=p.have_effects[i];
		let str=effects.names[e.type];
		if(vis[e.type]) {
			continue;
		}
		vis[e.type] = 1;
		cvs.fillStyle = colors.GOODEFFECTS;
		cvs.fillText(str,x-ty*11*str.length,y);
		cvs.fillStyle = colors.GOODEFFECTSBAR;
		let efs=p.find_have_effect(e.type);
		for (j in efs) {
			let e1=efs[j];
			cvs.fillRect(x-ty*pbw*(e1.time/e1.atime),y+10,pbw*(e1.time/e1.atime),pbh)
		}
		y = y + 30;
	}
	vis[0]=vis[1]=vis[2]=vis[3]=vis[4]=0;
	for (i in p.been_effects) {
		let e=p.been_effects[i];
		let str=effects.names[e.type];
		if(vis[e.type]) {
			continue;
		}
		vis[e.type] = 1;
		cvs.fillStyle = colors.BADEFFECTS;
		cvs.fillText(str,x-ty*11*str.length,y);
		cvs.fillStyle = colors.BADEFFECTSBAR;
		let efs=p.find_been_effect(e.type);
		for (j in efs) {
			let e1=efs[j];
			cvs.fillRect(x-ty*pbw*(e1.time/e1.atime),y+10,pbw*(e1.time/e1.atime),pbh)
		}
		y = y + 30;
	}
}

function drawhpbar(p,ty) {
	cvs.fillStyle = colors.BARBACKGROUND;
	cvs.fillRect(ty*(w-hpbw),1,hpbw,hpbh);
	cvs.fillStyle = colors.HPBAR_LIMIT;
	cvs.fillRect(ty*w-ty*hpbw+(1-ty)*(Math.round(hpbw*(p.blood_limit)/100)),1,Math.round(hpbw*(100-p.blood_limit)/100),hpbh);
	cvs.fillStyle = colors.HPBAR_RB;
	cvs.fillRect(ty*(w-Math.round(p.real_blood/100*hpbw)),1,Math.round(hpbw*p.real_blood/100),hpbh);
	cvs.fillStyle = colors.HPBAR;
	cvs.fillRect(ty*(w-Math.round(p.blood/100*hpbw)),1,Math.round(hpbw*p.blood/100),hpbh);
	let str=Math.round(p.blood).toString();
	let blen=str.length*11;
	cvs.font="20px Consolas";
	cvs.fillText(str,ty*w-ty*hpbw-ty*10-ty*blen+(1-ty)*(hpbw+10),18);
}

function update() {
	clock += 1;
	if (clock % 1 == 1) {
		lands.shift(1);
		lands.push(new Land());
	}

	draw_background();

	generatepack();
	delpacks();
	// console.log(effectpacks.length);

	playerA.check_hit(playerB);
	playerB.check_hit(playerA);

	playerA.update();
	playerB.update();

	drawhpbar(playerA,1);
	drawhpbar(playerB,0);

	draweffects(20,50,playerB,0);
	draweffects(w-20,50,playerA,1);

	if (!playerA.alive() && !playerB.alive()) { alert('Draw!'); return; }
	if (!playerA.alive()) { alert('PlayerB Win!'); return; }
	if (!playerB.alive()) { alert('PlayerA win!'); return; }

	for ( let i in lands) { lands[i].draw(); }
	for ( let i in effectpacks) { effectpacks[i].draw(); }

	requestAnimationFrame(update);
}

playerA.color=colors.PLAYERA;
playerB.color=colors.PLAYERB;

onload = init;
onkeydown = function(x) {
	let k = x.key;
	if (k == 'ArrowUp') {
		playerA.jump();
	} else if (k == 'ArrowLeft') {
		playerA.left();
	} else if (k == 'ArrowRight') {
		playerA.right();
	} else if (k == 'ArrowDown') {
		playerA.down()
	} else if (k == 'w') {
		playerB.jump();
	} else if (k == 'a') {
		playerB.left();
	} else if (k == 'd') {
		playerB.right();
	} else if (k == 's') {
		playerB.down();
	} else if (k == 'm') {
		playerA.start_fire();
	} else if (k == 'g') {
		playerB.start_fire();
	}
}

onkeyup = function(x) {
	let k = x.key;
	if (k == 'm') {
		playerA.stop_fire();
		// playerA.fire();
	} else if (k == 'g') {
		playerB.stop_fire();
		// playerB.fire();
	}
}

</script>

<style type="text/css">

</style>